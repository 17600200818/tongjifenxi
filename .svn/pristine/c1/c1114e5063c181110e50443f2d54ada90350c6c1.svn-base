<?phprequire_once("db.php");//  2 流量发送日志(exchange server记录)function parseBuyerRequestLog(&$arrRow){    global $arrResult, $arrPlace;    $buyerId = intval($arrRow[3]);    $nbr = intval($arrRow[4]);    if($nbr == 204){        $nbr = 0;    }    $req = json_decode($arrRow[5], true);    if ($req == false || empty($req)) {        return 2001;    }    if($req[imp][0]['banner']){        $w = intval($req["imp"][0]["banner"]['w']);        $h = intval($req["imp"][0]["banner"]['h']);    }else if($req[imp][0]['video']){        $w = intval($req["imp"][0]["video"]['w']);        $h = intval($req["imp"][0]["video"]['h']);    }else{        $w = 0;        $h = 0;    }    $placeId    = intval($req['imp'][0]['placeId']);       //广告位ID    $time	    = intval($req['ts']);  //时间戳    if(date("Y", $time) < 2017){        return 2002;    }    $date = date("Y-m-d", $time);    $hour = date("h", $time);    if($placeId < 1){        return 2003;    }    if($buyerId < 1){        return 2005;    }    if(isset($arrPlace[$placeId]) == false){        return 2004;    }    $sellerId = intval($arrPlace[$placeId]['sellerId']);    $mediaId = intval($arrPlace[$placeId]['mediaId']);    $arrResult['adx_report_sell']["summary_day"][$date][$sellerId]["request"] ++;    $arrResult['adx_report_sell']["media_day"][$date][$mediaId]["request"] ++;    $arrResult['adx_report_sell']["place_day"][$date][$placeId]["request"] ++;    $arrResult['adx_report_buy']["summary_day"][$date][$buyerId]["request"] ++;    $arrResult['adx_report']["summary_day"][$date][$sellerId][$buyerId]["request"] ++;    $arrResult['adx_report']["place_day"][$date][$placeId][$buyerId]["request"] ++;    $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["request"] ++;    $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["w"] = $w;    $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["h"] = $h;    if($sellerId != 100144 && $sellerId != 100149) {        $arrResult['adx_report']["place_hour"][$date][$hour][$placeId][$buyerId]["request"]++;    }    if(0 == $nbr) {        $arrResult['adx_report_sell']["summary_day"][$date][$sellerId]["requestOk"] ++;        $arrResult['adx_report_sell']["media_day"][$date][$mediaId]["requestOk"] ++;        $arrResult['adx_report_sell']["place_day"][$date][$placeId]["requestOk"] ++;        $arrResult['adx_report_buy']["summary_day"][$date][$buyerId]["requestOk"] ++;        $arrResult['adx_report']["summary_day"][$date][$sellerId][$buyerId]["requestOk"] ++;        $arrResult['adx_report']["place_day"][$date][$placeId][$buyerId]["requestOk"] ++;        $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["requestOk"] ++;        if($sellerId != 100144 && $sellerId != 100149) {            $arrResult['adx_report']["place_hour"][$date][$hour][$placeId][$buyerId]["requestOk"]++;        }    }else{        $arrResult['adx_report']["failure_day"][$date][$buyerId][$placeId][0][$nbr]["errorTotal"] ++;        $arrResult['adx_report']["failure_day"][$date][$buyerId][$placeId][0][$nbr]['errorId']=$nbr;    }    return 2000;}//  3 response日志(exchange server记录)function parseBuyerResponseLog(&$arrRow){    global $arrResult, $arrPlace, $arrCreative;    $buyerId = intval($arrRow[3]);    $nbr = intval($arrRow[4]);    if($nbr == 204){        $nbr = 0;    }    $req = json_decode($arrRow[5], true);    if ($req == false || empty($req)) {        return 3001;    }    if($req[imp][0]['banner']){        $w = intval($req["imp"][0]["banner"]['w']);        $h = intval($req["imp"][0]["banner"]['h']);    }else if($req[imp][0]['video']){        $w = intval($req["imp"][0]["video"]['w']);        $h = intval($req["imp"][0]["video"]['h']);    }else{        $w = 0;        $h = 0;    }    $placeId    = intval($req['imp'][0]['placeId']);       //广告位ID    $time	    = intval($req['ts']);  //时间戳    if(date("Y", $time) < 2017){        return 3002;    }    $date = date("Y-m-d", $time);    $hour = date("h", $time);    if($placeId < 1) {        return 3003;    }    if($buyerId < 1){        return 3006;    }    if(isset($arrPlace[$placeId]) == false){        return 3004;    }    $sellerId = intval($arrPlace[$placeId]['sellerId']);    $mediaId = intval($arrPlace[$placeId]['mediaId']);    $resp = json_decode($arrRow[6], true);    if ($resp == false || empty($resp)) {        return 3005;    }    $crid = 0;    if(isset($resp["seatbid"][0]["bid"][0]["crid"])){        $crid = intval($resp["seatbid"][0]["bid"][0]["crid"]);    }else{        if(isset($resp["seatbid"][0]["bid"][0]["buyerCrid"])){            $buyerCrid = trim($resp["seatbid"][0]["bid"][0]["buyerCrid"]);            $key = sprintf("%d_%s", $buyerId, $buyerCrid);            if(isset($arrCreative[$key])){                $crid = $arrCreative[$key]["id"];            }        }else if(isset($resp["seatbid"][0]["bid"][0]["iurl"])) {            $iurl = trim($resp["seatbid"][0]["bid"][0]["iurl"]);            $key = sprintf("%d_%s", $buyerId, $iurl);            if (isset($arrCreative[$key])) {                $crid = $arrCreative[$key]["id"];            }        }    }    if($nbr == 0){        if(!isset($resp["nbr"])){            $nbr = intval($resp["nbr"]);        }    }    if($nbr == 204){        $nbr = 0;    }    if($nbr == 0){        if(!isset($resp["seatbid"][0]["bid"][0]["nbr"])){            $nbr = intval($resp["seatbid"][0]["bid"][0]["nbr"]);        }    }    if(isset($resp["seatbid"][0]["bid"])) {        $arrResult['adx_report_sell']["summary_day"][$date][$sellerId]["bid"] ++;        $arrResult['adx_report_sell']["media_day"][$date][$mediaId]["bid"] ++;        $arrResult['adx_report_sell']["place_day"][$date][$placeId]["bid"] ++;        $arrResult['adx_report_buy']["summary_day"][$date][$buyerId]["bid"] ++;        $arrResult['adx_report']["summary_day"][$date][$sellerId][$buyerId]["bid"] ++;        $arrResult['adx_report']["place_day"][$date][$placeId][$buyerId]["bid"] ++;        $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["bid"] ++;        $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["w"] = $w;        $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["h"] = $h;        if($sellerId != 100144 && $sellerId != 100149) {            $arrResult['adx_report']["place_hour"][$date][$hour][$placeId][$buyerId]["bid"]++;        }    }    if($nbr == 0){        $arrResult['adx_report_sell']["summary_day"][$date][$sellerId]["response"] ++;        $arrResult['adx_report_sell']["media_day"][$date][$mediaId]["response"] ++;        $arrResult['adx_report_sell']["place_day"][$date][$placeId]["response"] ++;        $arrResult['adx_report_buy']["summary_day"][$date][$buyerId]["response"] ++;        $arrResult['adx_report']["summary_day"][$date][$sellerId][$buyerId]["response"] ++;        $arrResult['adx_report']["place_day"][$date][$placeId][$buyerId]["response"] ++;        $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["response"] ++;        if($sellerId != 100144 && $sellerId != 100149) {            $arrResult['adx_report']["place_hour"][$date][$hour][$placeId][$buyerId]["response"]++;        }    }else{        $arrResult['adx_report']["failure_day"][$date][$buyerId][$placeId][$crid][$nbr] ["errorId"]= $nbr;        $arrResult['adx_report']["failure_day"][$date][$buyerId][$placeId][$crid][$nbr] ["errorTotal"] ++;    }    return 3000;}//  4 竞价成功日志(exchange server记录)function parseBuyerBidSuccessLog(&$arrRow){    global $arrResult, $arrPlace;    $buyerId = intval($arrRow[3]);    $req = json_decode($arrRow[4], true);    if ($req == false || empty($req)) {        return 4001;    }    if($req[imp][0]['banner']){        $w = intval($req["imp"][0]["banner"]['w']);        $h = intval($req["imp"][0]["banner"]['h']);    }else if($req[imp][0]['video']){        $w = intval($req["imp"][0]["video"]['w']);        $h = intval($req["imp"][0]["video"]['h']);    }else{        $w = 0;        $h = 0;    }    $placeId    = intval($req['imp'][0]['placeId']);       //广告位ID    $time	    = intval($req['ts']);  //时间戳    if(date("Y", $time) < 2017){        return 4002;    }    $date = date("Y-m-d", $time);    $hour = date("h", $time);    if($placeId < 1){        return 4003;    }    if(isset($arrPlace[$placeId]) == false){        return 4004;    }    $resp = json_decode($arrRow[5], true);    if ($resp == false || empty($resp)) {        return 4005;    }    if($buyerId < 1){        return 4006;    }    $sellerId = intval($arrPlace[$placeId]['sellerId']);    $mediaId = intval($arrPlace[$placeId]['mediaId']);    $arrResult['adx_report_sell']["summary_day"][$date][$sellerId]["bidOk"] ++;    $arrResult['adx_report_sell']["media_day"][$date][$mediaId]["bidOk"] ++;    $arrResult['adx_report_sell']["place_day"][$date][$placeId]["bidOk"] ++;    $arrResult['adx_report_buy']["summary_day"][$date][$buyerId]["bidOk"]++;    $arrResult['adx_report']["summary_day"][$date][$sellerId][$buyerId]["bidOk"] ++;    $arrResult['adx_report']["place_day"][$date][$placeId][$buyerId]["bidOk"] ++;    $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["bidOk"] ++;    $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["w"] = $w;    $arrResult['adx_report_sell']["size_day"][$date][$sellerId][$w][$h]["h"] = $h;    if($sellerId != 100144 && $sellerId != 100149) {        $arrResult['adx_report']["place_hour"][$date][$hour][$placeId][$buyerId]["bidOk"]++;    }    return 4000;}